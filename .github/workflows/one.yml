name: zero

on:
   workflow_dispatch:
      inputs:
         version_bump:
            description: "Version bump (patch, minor, major)"
            required: true
            type: choice
            options:
               - patch
               - minor
               - major

jobs:
   compound:
      runs-on: [self-hosted, linux, x64]
      permissions:
         contents: write

      steps:
         - name: Checkout repository
           uses: actions/checkout@v4

         - name: Bump version and push tag
           id: tag_version
           uses: mathieudutour/github-tag-action@v6.1
           with:
              github_token: ${{ secrets.GITHUB_TOKEN }}
              default_bump: ${{ inputs.version_bump }}
              tag_prefix: v

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Log in to Docker Hub
           uses: docker/login-action@v3
           with:
              username: ${{ secrets.DOCKER_USER }}
              password: ${{ secrets.DOCKER_TOKEN }}

         - name: Build and push Docker image (patch)
           if: inputs.version_bump == 'patch'
           uses: docker/build-push-action@v5
           with:
              context: .
              push: true
              platforms: linux/amd64,linux/arm64
              tags: docker.io/timefactory/${{ github.event.repository.name }}:dev

         - name: Build and push Docker image (minor/major)
           if: inputs.version_bump == 'minor' || inputs.version_bump == 'major'
           uses: docker/build-push-action@v5
           with:
              context: .
              push: true
              platforms: linux/amd64,linux/arm64,linux/arm/v7
              tags: |
                 docker.io/timefactory/${{ github.event.repository.name }}:${{ steps.tag_version.outputs.new_tag }}
                 docker.io/timefactory/${{ github.event.repository.name }}:latest
